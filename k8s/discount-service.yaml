apiVersion: v1
kind: ConfigMap
metadata:
  name: discount-service-config
  namespace: demo
data:
  endpoints.json: |
    {
      "info": {
        "title": "Discount Service API",
        "description": "Mock discount, coupon, and promotion service for ecommerce platform",
        "version": "1.0.0"
      },
      "endpoints": [
        {
          "path": "/api/discounts",
          "method": "GET",
          "statusCode": 200,
          "summary": "List active discounts",
          "tags": ["Discounts"],
          "response": {
            "discounts": [
              {"id": "disc-001", "code": "SAVE20", "type": "percentage", "value": 20, "minPurchase": 50, "maxDiscount": 100, "expiresAt": "2024-02-28T23:59:59Z"},
              {"id": "disc-002", "code": "FREESHIP", "type": "free_shipping", "minPurchase": 35, "expiresAt": "2024-12-31T23:59:59Z"},
              {"id": "disc-003", "code": "FLAT10", "type": "fixed", "value": 10, "minPurchase": 30, "expiresAt": "2024-03-31T23:59:59Z"}
            ],
            "count": 3
          }
        },
        {
          "path": "/api/discounts/validate",
          "method": "POST",
          "statusCode": 200,
          "summary": "Validate discount code",
          "tags": ["Discounts"],
          "response": {
            "valid": true,
            "code": "SAVE20",
            "type": "percentage",
            "value": 20,
            "discountAmount": 40.00,
            "message": "Discount applied successfully"
          }
        },
        {
          "path": "/api/discounts/apply",
          "method": "POST",
          "statusCode": 200,
          "summary": "Apply discount to cart",
          "tags": ["Discounts"],
          "response": {
            "cartId": "cart-12345",
            "code": "SAVE20",
            "originalTotal": 200.00,
            "discountAmount": 40.00,
            "newTotal": 160.00,
            "message": "Discount applied to cart"
          }
        },
        {
          "path": "/api/discounts/remove",
          "method": "POST",
          "statusCode": 200,
          "summary": "Remove discount from cart",
          "tags": ["Discounts"],
          "response": {
            "cartId": "cart-12345",
            "message": "Discount removed from cart",
            "newTotal": 200.00
          }
        },
        {
          "path": "/api/coupons",
          "method": "GET",
          "statusCode": 200,
          "summary": "Get user's available coupons",
          "tags": ["Coupons"],
          "response": {
            "coupons": [
              {"id": "coup-001", "code": "WELCOME10", "type": "percentage", "value": 10, "description": "Welcome discount for new users", "expiresAt": "2024-02-15T23:59:59Z", "used": false},
              {"id": "coup-002", "code": "BIRTHDAY25", "type": "percentage", "value": 25, "description": "Birthday special discount", "expiresAt": "2024-01-31T23:59:59Z", "used": false},
              {"id": "coup-003", "code": "LOYALTY5", "type": "fixed", "value": 5, "description": "Loyalty reward", "expiresAt": "2024-06-30T23:59:59Z", "used": false}
            ],
            "count": 3
          }
        },
        {
          "path": "/api/promotions",
          "method": "GET",
          "statusCode": 200,
          "summary": "Get active promotions",
          "tags": ["Promotions"],
          "response": {
            "promotions": [
              {
                "id": "promo-001",
                "name": "Winter Sale",
                "description": "Up to 50% off on winter collection",
                "type": "category_discount",
                "categories": ["Fashion", "Sports"],
                "discount": 50,
                "startDate": "2024-01-01T00:00:00Z",
                "endDate": "2024-01-31T23:59:59Z",
                "banner": "https://example.com/banners/winter-sale.jpg"
              },
              {
                "id": "promo-002",
                "name": "Buy 2 Get 1 Free",
                "description": "Buy any 2 items and get 1 free",
                "type": "bundle",
                "categories": ["Electronics"],
                "startDate": "2024-01-15T00:00:00Z",
                "endDate": "2024-02-15T23:59:59Z",
                "banner": "https://example.com/banners/b2g1.jpg"
              }
            ]
          }
        },
        {
          "path": "/api/promotions/{id}",
          "method": "GET",
          "statusCode": 200,
          "summary": "Get promotion details",
          "tags": ["Promotions"],
          "response": {
            "id": "promo-001",
            "name": "Winter Sale",
            "description": "Up to 50% off on winter collection",
            "type": "category_discount",
            "categories": ["Fashion", "Sports"],
            "discount": 50,
            "terms": "Valid on selected items only. Cannot be combined with other offers.",
            "startDate": "2024-01-01T00:00:00Z",
            "endDate": "2024-01-31T23:59:59Z",
            "eligibleProducts": 156
          }
        },
        {
          "path": "/api/discounts/calculate",
          "method": "POST",
          "statusCode": 200,
          "summary": "Calculate best discount for cart",
          "tags": ["Discounts"],
          "response": {
            "cartTotal": 200.00,
            "bestDiscount": {
              "code": "SAVE20",
              "type": "percentage",
              "savings": 40.00
            },
            "otherApplicable": [
              {"code": "FLAT10", "savings": 10.00}
            ],
            "recommendation": "Use SAVE20 for maximum savings"
          }
        }
      ]
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: discount-service
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: discount-service
  template:
    metadata:
      labels:
        app: discount-service
    spec:
      containers:
      - name: discount-service
        image: ghcr.io/serviceweave/stubber:main
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: config
          mountPath: /config
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 2
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          requests:
            memory: "8Mi"
            cpu: "10m"
          limits:
            memory: "32Mi"
            cpu: "100m"
      volumes:
      - name: config
        configMap:
          name: discount-service-config
---
apiVersion: v1
kind: Service
metadata:
  name: discount-service
  namespace: demo
spec:
  selector:
    app: discount-service
  ports:
  - port: 80
    targetPort: 8080
